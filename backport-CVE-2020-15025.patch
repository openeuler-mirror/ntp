Subject: [PATCH] memory leak with AES128CMAC keys

Reference:https://archive.ntp.org/ntp4/ntp-4.2/ntp-4.2.8p15.tar.gz

---
 libntp/a_md5encrypt.c | 2 +-
 sntp/crypto.c         | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/libntp/a_md5encrypt.c b/libntp/a_md5encrypt.c
index 8c046f4..57100de 100644
--- a/libntp/a_md5encrypt.c
+++ b/libntp/a_md5encrypt.c
@@ -93,7 +93,7 @@ make_mac(
 		}
 	  cmac_fail:
 		if (ctx)
-			CMAC_CTX_cleanup(ctx);
+			CMAC_CTX_free(ctx);
 	}
 	else
 #   endif /*ENABLE_CMAC*/
diff --git a/sntp/crypto.c b/sntp/crypto.c
index 8ffe006..8a47ede 100644
--- a/sntp/crypto.c
+++ b/sntp/crypto.c
@@ -70,7 +70,8 @@ compute_mac(
 		}
 		len = (u_int)slen;
 		
-		CMAC_CTX_cleanup(ctx);
+		if (ctx)
+			CMAC_CTX_free(ctx);
 		/* Test our AES-128-CMAC implementation */
 		
 	} else	/* MD5 MAC handling */
-- 
1.8.3.1

